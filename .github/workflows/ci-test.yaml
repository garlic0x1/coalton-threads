name: ci-test

on: push

jobs:
  test:
    runs-on: ubuntu-latest
    container: bdockerimg/quicklisp
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: Clone Coalton
        uses: GuillaumeFalourd/clone-github-repo-action@v2.3
        with:
          owner: 'coalton-lang'
          repository: 'coalton'
      - name: Install Coalton
        run: |
          set -ex
          mv coalton /root/quicklisp/local-projects/
      - name: Run Tests
        run: |
          set -ex
          sbcl --disable-debugger \
               --load /root/quicklisp/setup.lisp \
               --eval '(ql:update-all-dists)' \
               --load coalton-threads.asd \
               --eval '(ql:quickload :coalton-threads/test)' \
               --eval '(asdf:test-system :coalton-threads/test)' \
               --eval '(quit)'